<!DOCTYPE html>
<html lang="en" class="login">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="content-language" content="en" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>System One</title>
		<!--Import custom styles.css-->
		<link type="text/css" rel="stylesheet" href="../css/vendor/fontawesome.min.css"  media="screen,projection"/>
		<link type="text/css" rel="stylesheet" href="../css/custom.min.css"  media="screen,projection"/>		
	</head>

<body class="light-grey">
	<div id="loader-wrapper">
		<div id="loader"></div>        
	</div>
	
	<main class="card">
		<h1 class="card-title dark-blue center">System One</h1>
		<h4 class="dark-blue center">Prescription</h4>

		<form id="prescription-form" novalidate>
			<div class="form-row">
				<button class="button fullwidth purple waves-effect waves-light" type="submit" value="Submit">Submit Random Prescription</button>
			</div>
		</form>


		<h4 class="ard-title dark-blue center">Bloodwork</h4>

		<form id="bloodwork-form" novalidate>
			<div class="form-row">
				<label>
					<i class="fas fa-envelope"></i> User Type
					<select id="user" name="user" aria-placeholder="Select User" role="listbox" data-validate="true" data-validation-type="required"></select>
				</label>
			</div>
			<div class="form-row">
				<label>
					<i class="fas fa-envelope"></i> User Type
					<select id="bloods" name="bloods" aria-placeholder="Select Bloodwork" role="listbox" data-validate="true" data-validation-type="required"></select>
				</label>
			</div>
			<div class="form-row">
				<button class="button fullwidth purple waves-effect waves-light" type="submit" value="Submit">Update Bloodwork</button>
			</div>
			<div id="firebase-error" class="alert callout hidden">
				<p><i class="fi-alert"></i><span id="firebase-error-message"></span></p>
			</div>
		</form>
	</main>
	<div id="toast"><!-- generated by javascript --></div>

	<!-- include main functionality of Firebase -->
	<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-app.js"></script>
	<!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
	<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-analytics.js"></script>
	<!-- Add Firebase products that you want to use -->
	<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-firestore.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-functions.js"></script>
	<script>
		// Your web app's Firebase configuration
		var firebaseConfig = {
			apiKey: "AIzaSyBZ1Qeu5SrCY1kxHfKsqarGIN2zx9fJEjE",
			authDomain: "complacent-aad-5db16.firebaseapp.com",
			projectId: "complacent-aad-5db16",
			storageBucket: "complacent-aad-5db16.appspot.com",
			messagingSenderId: "1095218295826",
			appId: "1:1095218295826:web:f8386b94a0301324f4d4cb"
		};
		// Initialize Firebase
		firebase.initializeApp(firebaseConfig);
		const auth = firebase.auth();
		const db = firebase.firestore();
		const functions = firebase.functions();
	</script>

	<script src="../js/vendor/waves.min.js"></script>
	<script src="../js/utility.js"></script>
	<script src="../js/data-arrays.js"></script>
	<script>

window.addEventListener("DOMContentLoaded", (event) => {

	const selectPatient = document.querySelector("#user");
	const selectBloodwork = document.querySelector("#bloods");
	for (let i = 0; i < patientarray.length; i ++) {
		option = document.createElement('option');
		option.setAttribute("value", nhsnoarray[i]);
		option.appendChild(document.createTextNode(patientarray[i]));
		selectPatient.appendChild(option);
	}
	for (let i = 0; i < bloodworkarray.length; i ++) {
		option = document.createElement('option');
		option.setAttribute("value", bloodworkarray[i].replace(/[&-\s]/gi, "_"));
		option.appendChild(document.createTextNode(bloodworkarray[i]));
		selectBloodwork.appendChild(option);
	}	

	hideLoader();

	document.querySelector("#bloodwork-form").addEventListener("submit", (event) => {
		event.preventDefault();

		showLoader();
		const today = new Date();
		const patquery = db.collection("patients").doc(selectPatient.value);
		
		patquery.get()
		.then(patientQuery => {
			const patient = patientQuery.data();
			patient[selectBloodwork.value] = today;
			patquery.set(patient)
			.then(patientQuery => {
				hideLoader();
				poptoast("Patient Bloodwork Updated", "green");
			}).catch((error) => {
				hideLoader();
				poptoast(error.message, "error");
			});
		}).catch((error) => {
			hideLoader();
			poptoast(error.message, "error");
		});		
	});


    document.querySelector("#prescription-form").addEventListener("submit", (event) => {
		event.preventDefault();

		const today = new Date();
		const patientInfo = Math.floor(Math.random() * 10);  // pick a random set of patient info
		
		showLoader();
		// randomly generate the data for the prescription
		let medicationList = [];
		const loopcount = Math.floor(Math.random() * 3) + 1; // 1-3 medications
		for (let i=1; i<=loopcount; i++){
			medicationList.push(medsarray[Math.floor(Math.random() * 122)]); // add random medications from the medication list
		}

		let prescription = { 
			patientName: patientarray[patientInfo],
			nhsNumber: nhsnoarray[patientInfo],
			address: addressarray[patientInfo],
			gpNumber: gpnoarray[patientInfo],
			issueDate: today.toString(),
			duration: Math.floor(Math.random() * 12) + 1,
			medicationList: medicationList,
		};

		console.log(prescription);

		const createPrescription = functions.httpsCallable("createPrescription");
		createPrescription(prescription)
		.then( result => {
			hideLoader();
			poptoast(result.data.message, "green");
		}).catch((error) => {
			hideLoader();
			poptoast(error.message, "error");
		});
		
	});
});
	</script> 
</body>
</html>
