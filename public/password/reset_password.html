<!DOCTYPE html>
<html lang="en" class="login">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="content-language" content="en" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Password Reset</title>
		<!--Import custom styles.css-->
		<link type="text/css" rel="stylesheet" href="../css/vendor/fontawesome.min.css"  media="screen,projection"/>
		<link type="text/css" rel="stylesheet" href="../css/custom.min.css"  media="screen,projection"/>		
	</head>

<body class="light-grey">
	<main class="card">
		<h1 class="card-title dark-blue center">Password Reset</h1>
		<div class="card-body" role="form" aria-label="Password Reset">
			<form id="password-form" novalidate>
				<div class="form-row">
					<label>
						<i class="fas fa-lock"></i> Password
						<input id="password" type="password" placeholder="password" aria-placeholder="Password" role="textbox" autocomplete="current-password" data-validate="true" data-validation-type="password">
						<span id="password-error" class="form-error"><i class="fas fa-times-circle"></i> Must be 8 characters including uppercase, lowercase, numbers and one of: @#$%^&+=!</span>
					</label>
				</div>
				<div class="form-row">
					<button class="button fullwidth purple waves-effect waves-light" type="submit" value="Submit">Reset Password</button>
				</div>
				<div class="form-row center purple-links">
					<a href="../login.html">Return to Login Screen</a>
				</div>
				<div id="firebase-error" class="alert callout hidden">
					<p><i class="fi-alert"></i><span id="firebase-error-message"></span></p>
				</div>
			</form>
		</div>
    </main>
    <div id="toast"><!-- generated by javascript --></div>


	<!-- include main functionality of Firebase -->
	<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-app.js"></script>
	<!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
	<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-analytics.js"></script>
	<!-- Add Firebase products that you want to use -->
	<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-auth.js"></script>
	<script>
		// Your web app's Firebase configuration
		var firebaseConfig = {
			apiKey: "AIzaSyBZ1Qeu5SrCY1kxHfKsqarGIN2zx9fJEjE",
			authDomain: "complacent-aad-5db16.firebaseapp.com",
			projectId: "complacent-aad-5db16",
			storageBucket: "complacent-aad-5db16.appspot.com",
			messagingSenderId: "1095218295826",
			appId: "1:1095218295826:web:f8386b94a0301324f4d4cb"
		};
		// Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        const auth = firebase.auth();
	</script>

	<script src="../js/vendor/waves.min.js"></script>
    <script src="../js/utility.js"></script>
	<script>
        document.addEventListener('DOMContentLoaded', function() {
			// Get the one-time code from the query parameter.
			const queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString);
            var actionCode = urlParams.get('oobCode');
            const form = document.querySelector('#password-form');
            const password = document.querySelector("#password");

            auth.verifyPasswordResetCode(actionCode).then(function(email) {
                // the code is valid so do nothing until the user submits
            }).catch(function(error) {
                // the code is not valid, redirect
                window.location.href = "../401.html";
            });

            password.addEventListener('blur', (event) => {
                validateControl(password);
            });

            form.addEventListener('submit', (event) => {
                event.preventDefault();
                document.querySelector('#firebase-error').classList.add("hidden");
                if(validateForm(form)){
                    auth.verifyPasswordResetCode(actionCode)
                    .then(function(email) {
                        auth.confirmPasswordReset(actionCode, password.value)
                        .then(function(resp) {
                            poptoast("Your Password was successfully reset!", "green");
                        }).catch(function(error) {
                            poptoast(error.message, "error");
                        });
                    }).catch(function(error) {
                        poptoast(error.message, "error");
                    });
                };
            });

        });
    </script> 
</body>
</html>
